<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å‘èµ·æ´»åŠ¨</title>
  <script src="./scripts/timeUtils.js"></script>
  <link rel="stylesheet" href="./styles/shared.css">
  <script type="module" src="scripts/authManager.js"></script>
  <script type="module" src="scripts/headerLoader.js"></script>
  <style>
    /* Page specific styles */
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .form-container {
      max-width: 700px !important;
      margin: 10px auto;
      padding: 2em 1.5em !important;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      margin-top: 3em;
      position: relative;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
    }
    
    h1 { 
      margin-bottom: 1em; 
    }
    
    .home-link {
      position: absolute;
      top: 2em;
      right: 1.5em;
      background: linear-gradient(135deg, #ff6b9d 0%, #ffa726 50%, #42a5f5 100%);
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    .home-link:hover {
      background: linear-gradient(135deg, #e55a8a 0%, #f57c00 50%, #1976d2 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
    }
    
    label { 
      display: block; 
      margin-top: 0.6em; 
      font-weight: 500; 
    }
    
    input, textarea {
      width: 100%;
      padding: 0.6em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    button {
      margin: 1.5em auto 0 auto;
      padding: 0.8em 1.5em;
      border: none;
      background: linear-gradient(135deg, #ff6b9d 0%, #ffa726 50%, #42a5f5 100%);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: block;
    }
    
    button:hover {
      background: linear-gradient(135deg, #e55a8a 0%, #f57c00 50%, #1976d2 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
    }
    
    .qrcode-preview {
      margin-top: 1em;
      max-width: 200px;
      border: 1px solid #ddd;
    }
    
    .message {
      margin-top: 1em;
      color: #d9534f;
    }
    
    /* æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
    .datetime-container {
      display: flex;
      gap: 1em;
      margin-top: 0.3em;
    }
    
    .date-input-group, .time-input-group {
      flex: 1;
    }
    
    .sub-label {
      display: block;
      font-size: 0.9em;
      color: #666;
      margin-bottom: 0.2em;
      font-weight: normal;
    }
    
    .quick-date-buttons, .quick-time-buttons {
      display: flex;
      gap: 0.4em;
      margin-top: 0.3em;
      flex-wrap: wrap;
    }
    
    .quick-btn {
       padding: 0.4em 0.8em;
       font-size: 0.8em;
       background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(255, 167, 38, 0.1) 50%, rgba(66, 165, 245, 0.1) 100%);
       border: 1px solid rgba(255, 107, 157, 0.3);
       border-radius: 4px;
       cursor: pointer;
       transition: all 0.2s ease;
       margin: 0;
       color: #333;
       font-weight: 500;
     }
     
     .quick-btn:hover {
       background: linear-gradient(135deg, rgba(255, 107, 157, 0.2) 0%, rgba(255, 167, 38, 0.2) 50%, rgba(66, 165, 245, 0.2) 100%);
       border-color: rgba(255, 107, 157, 0.5);
       transform: translateY(-1px);
       box-shadow: 0 4px 12px rgba(255, 107, 157, 0.2);
     }
     
     .quick-btn:active {
       background: linear-gradient(135deg, rgba(255, 107, 157, 0.3) 0%, rgba(255, 167, 38, 0.3) 50%, rgba(66, 165, 245, 0.3) 100%);
       transform: translateY(0);
       box-shadow: 0 2px 6px rgba(255, 107, 157, 0.3);
     }
    
    @media (max-width: 600px) {
      .datetime-container {
        flex-direction: column;
        gap: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <!-- å…±äº«Headerå®¹å™¨ -->
  <div id="shared-header-container"></div>

  <div class="form-container">
    <label>æ´»åŠ¨æ ‡é¢˜ <span style="color: red;">*</span></label>
    <input id="title" placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜"/>

    <label>æ´»åŠ¨æ—¶é—´ <span style="color: red;">*</span></label>
    <div class="datetime-container">
      <div class="date-input-group">
        <!-- <label class="sub-label">æ—¥æœŸ</label> -->
        <input id="date" type="date" />
        <div class="quick-date-buttons">
          <button type="button" class="quick-btn" onclick="setQuickDate(0)">ä»Šå¤©</button>
          <button type="button" class="quick-btn" onclick="setQuickDate(1)">æ˜å¤©</button>
          <button type="button" class="quick-btn" onclick="setQuickDate(7)">ä¸‹å‘¨</button>
        </div>
      </div>
      <div class="time-input-group">
        <!-- <label class="sub-label">æ—¶é—´</label> -->
        <input id="time" type="time" />
        <div class="quick-time-buttons">
          <button type="button" class="quick-btn" onclick="setQuickTime('09:00')">ä¸Šåˆ9ç‚¹</button>
          <button type="button" class="quick-btn" onclick="setQuickTime('14:00')">ä¸‹åˆ2ç‚¹</button>
          <button type="button" class="quick-btn" onclick="setQuickTime('19:00')">æ™šä¸Š7ç‚¹</button>
        </div>
      </div>
    </div>
    <input id="datetime" type="hidden" />

    <label>æ´»åŠ¨åœ°ç‚¹ <span style="color: red;">*</span></label>
    <input id="location" placeholder="è¯·è¾“å…¥æ´»åŠ¨åœ°ç‚¹"/>

    <label>æ´»åŠ¨æè¿° <span style="color: red;">*</span></label>
    <textarea id="description" rows="5" placeholder="è¯·å¡«å†™æ´»åŠ¨å†…å®¹"></textarea>
    <div style="margin-top: 0.5em; display: flex; align-items: center; gap: 1em;">
      <button type="button" id="generateDescriptionBtn" class="btn btn-secondary" onclick="generateActivityDescription()" style="margin: 0; padding: 0.5em 1em; font-size: 0.9em;">
         AIç”Ÿæˆæ´»åŠ¨ä»‹ç»
      </button>
      <div id="generateDescriptionStatus" style="font-size: 0.9em; color: #666;"></div>
    </div>

    <label>å¾®ä¿¡å· <span style="color: red;">*</span></label>
    <input id="wechat" placeholder="è¯·è¾“å…¥ä½ çš„å¾®ä¿¡å·"/>

    <label>æ´»åŠ¨æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
    <input id="duration" type="number" step="0.5" min="0.5" placeholder="è¯·è¾“å…¥æ´»åŠ¨æ—¶é•¿ï¼Œå¦‚ï¼š2 æˆ– 1.5"/>

    <label>æ´»åŠ¨ç¾¤äºŒç»´ç </label>
    <input id="qrcodeInput" type="file" accept="image/*"/>
    <img id="qrcodePreview" class="qrcode-preview" style="display:none"/>
    <div class="message" id="message"></div>
    <button onclick="submitForm()">å‘èµ·æ´»åŠ¨</button>
  </div>
  <script type="module" src="scripts/cacheManager.js"></script>
  <script type="module" src="scripts/apiWithCache.js"></script>
  <script>
    let qrcodeBase64 = '';
    // ç‚¹å‡»æ¬¡æ•°è®¡æ•°å™¨
    let generateClickCount = 0;
    const maxGenerateClicks = 2;
    
    // å°†submitFormå‡½æ•°å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
    window.submitForm = async function() {
      const title = document.getElementById("title").value.trim();
      const datetimeLocal = document.getElementById("datetime").value;
      const location = document.getElementById("location").value.trim();
      const duration = parseFloat(document.getElementById("duration").value);
      const description = document.getElementById("description").value.trim();
      const wechat = document.getElementById("wechat").value.trim();

      if (!title || !datetimeLocal || !location || !description || !wechat) {
        document.getElementById("message").innerText = "è¯·å¡«å†™æ‰€æœ‰å¿…å¡«ä¿¡æ¯";
        return;
      }

      // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†å‡½æ•°åˆ›å»ºæ—¶é—´å¯¹è±¡
      const datetime = TimeUtils.createDateTimeObject(datetimeLocal);

      // å…ˆä¸Šä¼ äºŒç»´ç å›¾ç‰‡
      let qrcodeUrl = '';
      if (qrcodeBase64) {
        try {
          const { apiWithCache } = await import('./scripts/apiWithCache.js');
          const uploadResult = await apiWithCache.uploadImageToGitHub({ base64Image: qrcodeBase64 });
          console.log('Upload response:', uploadResult);
          
          if (uploadResult.success) {
            qrcodeUrl = uploadResult.url;
            console.log('QR code uploaded successfully:', qrcodeUrl);
          } else {
            console.error('QR code upload failed:', uploadResult);
            document.getElementById("message").innerText = `äºŒç»´ç ä¸Šä¼ å¤±è´¥: ${uploadResult.error || 'æœªçŸ¥é”™è¯¯'}`;
            return;
          }
        } catch (uploadError) {
          console.error('QR code upload error:', uploadError);
          document.getElementById("message").innerText = 'äºŒç»´ç ä¸Šä¼ æ—¶å‘ç”Ÿé”™è¯¯';
          return;
        }
      }

      try {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        const { authManager } = await import('./scripts/authManager.js');
        const currentUser = await authManager.getCurrentUser();
        const creator = currentUser ? currentUser.username : null;
        
        const { apiWithCache } = await import('./scripts/apiWithCache.js');
        const result = await apiWithCache.createMeetup({ title, datetime, location, duration, description, wechat, qrcode: qrcodeUrl, creator });

        if (result.id && result.manage_token) {
          // æ ¹æ®ç”¨æˆ·ç™»å½•çŠ¶æ€å†³å®šè·³è½¬ç›®æ ‡
          if (currentUser) {
            // å·²ç™»å½•ç”¨æˆ·è·³è½¬åˆ°æˆ‘çš„æ´»åŠ¨é¡µ
            window.location.href = `${window.location.origin}/my-meetups`;
          } else {
            // æœªç™»å½•ç”¨æˆ·è·³è½¬åˆ°æ´»åŠ¨ç®¡ç†é¡µ
            const manageLink = `${window.location.origin}/meetup-manage?token=${result.manage_token}`;
            window.location.href = manageLink;
          }
        } else {
          document.getElementById("message").innerText = result.error || "æäº¤å¤±è´¥";
        }
      } catch (error) {
        console.error('Create meetup error:', error);
        document.getElementById("message").innerText = "åˆ›å»ºæ´»åŠ¨æ—¶å‘ç”Ÿé”™è¯¯";
      }
    };
    
    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      });
    };

    // AIç”Ÿæˆæ´»åŠ¨ä»‹ç»åŠŸèƒ½
    window.generateActivityDescription = async function() {
      // æ£€æŸ¥ç‚¹å‡»æ¬¡æ•°é™åˆ¶
      if (generateClickCount >= maxGenerateClicks) {
        document.getElementById("generateDescriptionStatus").innerText = "å·²è¾¾åˆ°æœ€å¤§ç”Ÿæˆæ¬¡æ•°é™åˆ¶ï¼ˆ2æ¬¡ï¼‰";
        document.getElementById("generateDescriptionStatus").style.color = "#f44336";
        return;
      }
      
      const title = document.getElementById("title").value.trim();
      const location = document.getElementById("location").value.trim();
      const duration = document.getElementById("duration").value.trim();
      const currentDescription = document.getElementById("description").value.trim();
      
      if (!title) {
        document.getElementById("generateDescriptionStatus").innerText = "è¯·å…ˆå¡«å†™æ´»åŠ¨æ ‡é¢˜";
        return;
      }
      
      // å¢åŠ ç‚¹å‡»æ¬¡æ•°
      generateClickCount++;
      
      const btn = document.getElementById("generateDescriptionBtn");
      const status = document.getElementById("generateDescriptionStatus");
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      btn.disabled = true;
      btn.innerText = "ğŸ¤– ç”Ÿæˆä¸­...";
      status.innerText = "æ­£åœ¨ç”Ÿæˆæ´»åŠ¨ä»‹ç»ï¼Œè¯·ç¨å€™...";
      status.style.color = "#666";
      
      try {
        // æ„å»ºæ´»åŠ¨ä¿¡æ¯
        const activityInfo = {
          title: title,
          location: location || "å¾…å®š",
          duration: duration ? `${duration}å°æ—¶` : "å¾…å®š",
          currentDescription: currentDescription || "æ— "
        };
        
        const response = await fetch('/.netlify/functions/generateActivityDescription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(activityInfo)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.description) {
          document.getElementById("description").value = result.description;
          status.innerText = "âœ… æ´»åŠ¨ä»‹ç»å·²ç”Ÿæˆ";
          status.style.color = "#4CAF50";
        } else {
          throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        }
      } catch (error) {
        console.error('ç”Ÿæˆæ´»åŠ¨ä»‹ç»å¤±è´¥:', error);
        status.innerText = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
        status.style.color = "#f44336";
        // å¦‚æœå¤±è´¥ï¼Œå‡å°‘ç‚¹å‡»æ¬¡æ•°
        generateClickCount--;
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
        const remainingClicks = maxGenerateClicks - generateClickCount;
        if (remainingClicks > 0) {
          btn.innerText = `ğŸ¤– AIç”Ÿæˆæ´»åŠ¨ä»‹ç» (${remainingClicks}/${maxGenerateClicks})`;
        } else {
          btn.innerText = "ğŸ¤– å·²è¾¾ä½¿ç”¨é™åˆ¶";
          btn.disabled = true;
        }
        
        // 3ç§’åæ¸…é™¤çŠ¶æ€ä¿¡æ¯
        setTimeout(() => {
          status.innerText = "";
        }, 3000);
      }
    };
  </script>
  <script type="module">

    // å¿«æ·æ—¥æœŸè®¾ç½®å‡½æ•°
    window.setQuickDate = function(daysFromNow) {
      const date = new Date();
      date.setDate(date.getDate() + daysFromNow);
      const dateStr = date.getFullYear() + '-' + 
        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
        String(date.getDate()).padStart(2, '0');
      document.getElementById('date').value = dateStr;
      updateDateTime();
    };
    
    // å¿«æ·æ—¶é—´è®¾ç½®å‡½æ•°
    window.setQuickTime = function(timeStr) {
      document.getElementById('time').value = timeStr;
      updateDateTime();
    };
    
    // æ›´æ–°éšè—çš„datetimeå­—æ®µ
    function updateDateTime() {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if (date && time) {
        document.getElementById('datetime').value = date + 'T' + time;
      }
    }
    
    // è®¾ç½®æ´»åŠ¨æ—¶é—´é»˜è®¤å€¼ä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´
    window.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      
      // è®¾ç½®æ—¥æœŸ
      const dateStr = now.getFullYear() + '-' + 
        String(now.getMonth() + 1).padStart(2, '0') + '-' + 
        String(now.getDate()).padStart(2, '0');
      document.getElementById('date').value = dateStr;
      
      // è®¾ç½®æ—¶é—´ï¼ˆå‘ä¸Šå–æ•´åˆ°ä¸‹ä¸€ä¸ªå°æ—¶ï¼‰
      const nextHour = new Date(now);
      nextHour.setHours(now.getHours() + 1, 0, 0, 0);
      const timeStr = String(nextHour.getHours()).padStart(2, '0') + ':00';
      document.getElementById('time').value = timeStr;
      
      // æ›´æ–°éšè—å­—æ®µ
      updateDateTime();
      
      // ç›‘å¬æ—¥æœŸå’Œæ—¶é—´å˜åŒ–
      document.getElementById('date').addEventListener('change', updateDateTime);
      document.getElementById('time').addEventListener('change', updateDateTime);
    });

    document.getElementById("qrcodeInput").addEventListener("change", function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          qrcodeBase64 = e.target.result;
          document.getElementById("qrcodePreview").src = qrcodeBase64;
          document.getElementById("qrcodePreview").style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    });


  </script>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-simple">
        <div class="footer-logo">
          <img src="logo.svg" alt="èšå‹åœˆLogo" width="24" height="24">
          <span class="footer-brand">èšå‹åœˆ</span>
        </div>
        <p class="footer-text">&copy; 2025 èšå‹åœˆ - æ„¿æ¯ä¸€æ¬¡æ´»åŠ¨ï¼Œéƒ½æ˜¯ä¸€æ¬¡é è¿‘</p>
      </div>
    </div>
  </footer>

  <!-- Auth Utils Script -->
  <script src="https://bysunling.com/scripts/auth-utils.js"></script>
  
  <!-- Auth Functionality Script -->
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuthStatus() {
      const authInfo = document.getElementById('auth-info');
      const loginBtn = document.getElementById('login-btn');
      const userNameSpan = document.getElementById('user-name');
      
      // ä¼˜å…ˆä½¿ç”¨ crossDomainAuthï¼Œé™çº§åˆ° localStorage
      let token, user;
      if (window.crossDomainAuth) {
        token = window.crossDomainAuth.getToken();
        user = window.crossDomainAuth.getUser();
      } else {
        token = localStorage.getItem('authToken');
        user = localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : null;
      }
      
      if (token && user) {
        // å·²ç™»å½•çŠ¶æ€
        authInfo.style.display = 'flex';
        loginBtn.style.display = 'none';
        userNameSpan.textContent = user.username || user.email || 'ç”¨æˆ·';
      } else {
        // æœªç™»å½•çŠ¶æ€
        authInfo.style.display = 'none';
        loginBtn.style.display = 'inline-block';
      }
    }
    
    // é€€å‡ºç™»å½•
    function logout() {
      // ä¼˜å…ˆä½¿ç”¨ crossDomainAuthï¼Œé™çº§åˆ° localStorage
      if (window.crossDomainAuth) {
        window.crossDomainAuth.clearAuth();
      } else {
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
      }
      
      // æ›´æ–°UI
      checkAuthStatus();
      
      // å¯é€‰ï¼šé‡æ–°åŠ è½½é¡µé¢æˆ–é‡å®šå‘
      window.location.reload();
    }
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
      
      // ç»‘å®šé€€å‡ºæŒ‰é’®äº‹ä»¶
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
    });
    
    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆå¦‚æœæœ‰å…¶ä»–é¡µé¢æ›´æ–°äº†è®¤è¯çŠ¶æ€ï¼‰
    window.addEventListener('storage', function(e) {
      if (e.key === 'authToken' || e.key === 'user') {
        checkAuthStatus();
      }
    });
  </script>

</body>
</html>
