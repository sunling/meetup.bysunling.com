<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†æ´»åŠ¨ä¿¡æ¯</title>
  <script src="./scripts/timeUtils.js"></script>
  <link rel="stylesheet" href="./styles/shared.css">
  <style>
    .container {
      max-width: 800px;
      padding: 2rem 1.5rem;
    }
    
    .page-header {
      position: relative;
    }
    
    .home-link {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 0.9rem;
    }
    
    /* å†…å®¹åŒºåŸŸæ ·å¼ */
    .content-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      border: 1px solid rgba(255, 107, 157, 0.15);
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }
    
    .content-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* é“¾æ¥æ¡†æ ·å¼ */
    .link-box {
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.08) 0%, rgba(66, 165, 245, 0.06) 100%);
      border: 1px solid rgba(255, 107, 157, 0.15);
      border-radius: var(--radius-md);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all var(--transition-fast);
    }
    
    .link-box:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.15);
    }
    
    .link-box input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      font-family: 'SF Mono', 'Monaco', monospace;
    }
    
    .link-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.2);
    }
    
    .link-label {
      min-width: 120px;
      font-weight: 500;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    
    /* QRç ç®¡ç†æ ·å¼ */
    .qr-current {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.6);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
    }
    
    .qr-current img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: var(--radius-lg);
      border: 2px solid var(--primary-color);
      box-shadow: var(--shadow-md);
    }
    
    .qr-upload {
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.4);
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(255, 107, 157, 0.3);
    }
    
    .qr-upload input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-card);
      transition: all var(--transition-fast);
    }
    
    .qr-upload input[type="file"]:hover {
      border-color: var(--primary-color);
    }
    
    .qr-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: var(--radius-lg);
      border: 2px solid var(--primary-color);
      box-shadow: var(--shadow-md);
    }
    
    /* RSVPåˆ—è¡¨æ ·å¼ */
    .rsvp-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .rsvp-item {
      padding: 1rem;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      transition: all var(--transition-fast);
    }
    
    .rsvp-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .rsvp-item.status-going {
      border-left: 4px solid var(--success-color);
      background: linear-gradient(135deg, rgba(102, 187, 106, 0.1) 0%, var(--bg-card) 100%);
    }
    
    .rsvp-item.status-maybe {
      border-left: 4px solid var(--warning-color);
      background: linear-gradient(135deg, rgba(255, 235, 59, 0.1) 0%, var(--bg-card) 100%);
    }
    
    .rsvp-header {
      font-weight: 600;
      color: var(--text-light);
      font-size: 1.1rem;
    }
    
    /* çŠ¶æ€æ¶ˆæ¯æ ·å¼ */
    .status-message {
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      display: none;
    }
    
    .status-message.success {
      background: var(--success-light);
      color: var(--success-dark);
      border: 1px solid var(--success-color);
    }
    
    .status-message.error {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    
    /* ç¼–è¾‘è¡¨å•æ ·å¼ */
    .edit-form {
      display: none;
    }
    
    .form-actions {
      display: flex;
      gap: 1rem;
    }
    
    /* æ´»åŠ¨æè¿°æ ·å¼ */
    .meetup-description {
      white-space: pre-line;
      background: linear-gradient(135deg, rgba(255, 107, 157, 0.08) 0%, rgba(66, 165, 245, 0.06) 100%);
      padding: 1.5rem;
      border-radius: var(--radius-lg);
      /* border-left: 4px solid var(--primary-color); */
      line-height: 1.7;
    }
    
    /* æ´»åŠ¨å…ƒä¿¡æ¯æ ·å¼ */
    .meetup-meta p {
      line-height: 1.6;
    }
    
    .meetup-meta strong {
      font-weight: 600;
      color: var(--text-light);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .home-link {
        position: static;
        display: block;
        text-align: center;
      }
      
      .link-box {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      
      .link-label {
        min-width: auto;
      }
      
      .qr-current {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      
      .form-actions {
        flex-direction: column;
      }
    }
  </style>
   
</head>
<body>
  <div class="container">
    <div class="page-header mb-4">
      <h1 class="title-dopamine">æ´»åŠ¨ç®¡ç†é¡µ</h1>
      <a href="index.html" class="btn btn-dopamine home-link">ğŸ  å›åˆ°é¦–é¡µ</a>
    </div>
    
    <div class="card mb-4" id="meetup-info">
      <div class="card-body">
        <h2 class="subtitle-dopamine mb-3">æ´»åŠ¨ä¿¡æ¯</h2>
        <div class="content-section">
          <p>æ­£åœ¨åŠ è½½æ´»åŠ¨ä¿¡æ¯...</p>
        </div>
      </div>
    </div>

    <div class="card mb-4" id="qr-manage">
      <div class="card-body">
        <h2 class="subtitle-dopamine mb-3">å¾®ä¿¡ç¾¤äºŒç»´ç ç®¡ç†</h2>
        <div class="content-section">
          <div class="qr-current mb-3" id="qr-current">
            <img id="current-qr-img" src="" alt="å½“å‰äºŒç»´ç " style="display: none;">
            <div class="qr-info">
              <p><strong>å½“å‰äºŒç»´ç çŠ¶æ€ï¼š</strong><span id="qr-status">åŠ è½½ä¸­...</span></p>
              <p class="text-muted">äºŒç»´ç ä¼šå®šæœŸè¿‡æœŸï¼Œè¯·åŠæ—¶æ›´æ–°ä»¥ç¡®ä¿æ–°æˆå‘˜èƒ½å¤ŸåŠ å…¥å¾®ä¿¡ç¾¤ã€‚</p>
            </div>
          </div>
          
          <div class="qr-upload mt-3">
            <h3 class="mb-3">ä¸Šä¼ æ–°çš„äºŒç»´ç </h3>
            <input type="file" id="qr-file-input" accept="image/*" class="mb-3" />
            <img id="qr-preview" class="qr-preview mb-3" style="display: none;" />
            <button class="btn btn-dopamine" id="update-qr-btn" disabled>æ›´æ–°äºŒç»´ç </button>
            <div class="status-message mt-3" id="update-status"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="rsvp-info">
      <div class="card-body">
        <h2 class="subtitle-dopamine mb-3">å‚ä¸è€…åˆ—è¡¨</h2>
        <div class="content-section">
          <p>åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadMeetupData() {
      const token = new URLSearchParams(window.location.search).get("token");
      if (!token) {
        document.getElementById("meetup-info").innerHTML = "âŒ ç¼ºå°‘ token å‚æ•°ã€‚";
        return;
      }

      try {
        const res = await fetch(`/.netlify/functions/getMeetupDetails?token=${token}`);
        const result = await res.json();

        if (!res.ok || result.error) {
          document.getElementById("meetup-info").innerHTML = `âŒ è¯»å–æ´»åŠ¨å¤±è´¥ï¼š${result.error}`;
          return;
        }

        const { meetup, rsvps } = result;

        // Get public URL for sharing
        const publicUrl = `${window.location.origin}/meetup?meetup_id=${meetup.id}`;

        document.getElementById("meetup-info").innerHTML = `
          <div class="card-body">
            <h2 class="subtitle-dopamine mb-3">æ´»åŠ¨ä¿¡æ¯</h2>
            <div class="content-section" id="meetup-display">
              <h3 id="display-title" class="mb-3">${meetup.title}</h3>
              <div class="meetup-meta mb-3">
                <p><strong>æ—¶é—´ï¼š</strong> <span id="display-datetime">${formatDateTime(meetup.datetime)}</span></p>
                <p><strong>åœ°ç‚¹ï¼š</strong> <span id="display-location">${meetup.location}</span></p>
                <p><strong>å‘èµ·äººå¾®ä¿¡å·ï¼š</strong> ${meetup.wechat_id}</p>
              </div>
              <div class="meetup-description mb-4" id="display-description">${meetup.description}</div>
              
              <div class="link-box mb-3">
                <span class="link-label">ğŸ“‹ ç®¡ç†é¡µé¢é“¾æ¥ï¼š</span>
                <input type="text" value="${window.location.href}" readonly onclick="this.select()">
                <button class="btn btn-secondary" id="copy-manage-button">å¤åˆ¶</button>
              </div>
              <div class="link-box mb-3">
                <span class="link-label">ğŸ”— æ´»åŠ¨æŠ¥åé“¾æ¥ï¼š</span>
                <input type="text" value="${publicUrl}" readonly onclick="this.select()">
                <button class="btn btn-secondary" id="copy-signup-button">å¤åˆ¶</button>
              </div>
              
              <div class="text-center">
                <button class="btn btn-dopamine" id="edit-button">ç¼–è¾‘æ´»åŠ¨ä¿¡æ¯</button>
              </div>
            </div>
          
          <div class="edit-form content-section mt-3" id="edit-form">
            <h3 class="mb-3">ç¼–è¾‘æ´»åŠ¨ä¿¡æ¯</h3>
            <div class="form-group">
              <label for="edit-title" class="form-label">æ´»åŠ¨æ ‡é¢˜</label>
              <input type="text" id="edit-title" class="form-input" value="${meetup.title}">
            </div>
            <div class="form-group">
              <label for="edit-datetime" class="form-label">æ´»åŠ¨æ—¶é—´</label>
              <input type="datetime-local" id="edit-datetime" class="form-input" value="${TimeUtils.formatDateTimeForInput(meetup.datetime)}">
            </div>
            <div class="form-group">
              <label for="edit-location" class="form-label">æ´»åŠ¨åœ°ç‚¹</label>
              <input type="text" id="edit-location" class="form-input" value="${meetup.location}">
            </div>
            <div class="form-group">
              <label for="edit-description" class="form-label">æ´»åŠ¨è¯¦æƒ…</label>
              <textarea id="edit-description" class="form-input form-textarea">${meetup.description}</textarea>
            </div>
            <div class="form-actions">
              <button class="btn btn-dopamine" id="save-button">ä¿å­˜ä¿®æ”¹</button>
              <button class="btn btn-secondary" id="cancel-button">å–æ¶ˆ</button>
            </div>
            <div class="status-message mt-3" id="edit-status"></div>
          </div>
        </div>
        `;

        // Display current QR code
        displayCurrentQRCode(meetup.qrcode);
        
        // Initialize QR code management
        initQRCodeManagement(token);
        
        // Initialize edit functionality
        initEditFunctionality(token, meetup);

        // Add copy management link functionality
        document.getElementById("copy-manage-button").addEventListener("click", async () => {
          const button = document.getElementById("copy-manage-button");
          const input = button.parentElement.querySelector('input');
          if (input) {
            input.select();
            try {
              await navigator.clipboard.writeText(input.value);
              button.textContent = "âœ… å·²å¤åˆ¶";
              setTimeout(() => {
                button.textContent = "å¤åˆ¶ç®¡ç†é“¾æ¥";
              }, 2000);
            } catch (err) {
              alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
            }
          }
        });
        
        // Add copy signup link functionality
        document.getElementById("copy-signup-button").addEventListener("click", async () => {
          const button = document.getElementById("copy-signup-button");
          const input = button.parentElement.querySelector('input');
          if (input) {
            input.select();
            try {
              await navigator.clipboard.writeText(input.value);
              button.textContent = "âœ… å·²å¤åˆ¶";
              setTimeout(() => {
                button.textContent = "å¤åˆ¶æŠ¥åé“¾æ¥";
              }, 2000);
            } catch (err) {
              alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
            }
          }
        });

        if (!Array.isArray(rsvps) || rsvps.length === 0) {
          document.getElementById("rsvp-info").innerHTML = `
            <div class="card-body">
              <h2 class="subtitle-dopamine mb-3">å‚ä¸è€…åˆ—è¡¨</h2>
              <div class="content-section">
                <p class="text-center text-muted">ç›®å‰è¿˜æ²¡æœ‰äººæŠ¥åã€‚</p>
              </div>
            </div>
          `;
          return;
        }

        // Group RSVPs by status
        const going = rsvps.filter(item => item.status === 'going');
        const maybe = rsvps.filter(item => item.status === 'maybe');
        
        let rsvpContent = `
          <div class="card-body">
            <h2 class="subtitle-dopamine mb-3">å‚ä¸è€…åˆ—è¡¨</h2>
            <div class="content-section">
        `;
        
        // Add going RSVPs
        if (going.length > 0) {
          rsvpContent += `<div class="rsvp-header mb-2">ç¡®å®šå‚åŠ  (${going.length})</div>`;
          rsvpContent += `<ul class="rsvp-list mb-4">`;
          
          for (const item of going) {
            rsvpContent += `
              <li class="rsvp-item status-going mb-2">${item.name}ï¼ˆå¾®ä¿¡å·ï¼š${item.wechat_id}ï¼‰</li>
            `;
          }
          
          rsvpContent += `</ul>`;
        }
        
        // Add maybe RSVPs
        if (maybe.length > 0) {
          rsvpContent += `<div class="rsvp-header mb-2">æ„Ÿå…´è¶£ (${maybe.length})</div>`;
          rsvpContent += `<ul class="rsvp-list">`;
          
          for (const item of maybe) {
            rsvpContent += `
              <li class="rsvp-item status-maybe mb-2">${item.name}ï¼ˆå¾®ä¿¡å·ï¼š${item.wechat_id}ï¼‰</li>
            `;
          }
          
          rsvpContent += `</ul>`;
        }
        
        rsvpContent += `
            </div>
          </div>
        `;

        document.getElementById("rsvp-info").innerHTML = rsvpContent;
      } catch (err) {
        document.getElementById("meetup-info").innerHTML = `âŒ åŠ è½½å¤±è´¥ï¼š${err.message}`;
      }
    }

    loadMeetupData();

    // QR Code management functions
    function displayCurrentQRCode(qrcode) {
      const qrImg = document.getElementById('current-qr-img');
      const qrStatus = document.getElementById('qr-status');
      
      if (qrcode) {
        qrImg.src = qrcode;
        qrImg.style.display = 'block';
        qrStatus.textContent = 'å·²è®¾ç½®';
      } else {
        qrImg.style.display = 'none';
        qrStatus.textContent = 'æœªè®¾ç½®';
      }
    }

    function initQRCodeManagement(token) {
      const fileInput = document.getElementById('qr-file-input');
      const preview = document.getElementById('qr-preview');
      const updateBtn = document.getElementById('update-qr-btn');
      const statusDiv = document.getElementById('update-status');
      
      let qrcodeBase64 = '';
      
      // Handle file selection
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            qrcodeBase64 = e.target.result;
            preview.src = qrcodeBase64;
            preview.style.display = 'block';
            updateBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Handle QR code update
      updateBtn.addEventListener('click', async function() {
        if (!qrcodeBase64) {
          showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶', 'error');
          return;
        }
        
        updateBtn.disabled = true;
        updateBtn.textContent = 'ä¸Šä¼ ä¸­...';
        
        try {
          // First upload the image
          const uploadRes = await fetch('/.netlify/functions/uploadImageToGitHub', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ base64Image: qrcodeBase64 })
          });
          
          const uploadResult = await uploadRes.json();
          
          if (!uploadRes.ok || uploadResult.error) {
            throw new Error(uploadResult.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
          }
          
          const qrcodeUrl = uploadResult.url;
          
          // Then update the meetup with new QR code URL
          const updateRes = await fetch('/.netlify/functions/updateMeetup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token, qrcode: qrcodeUrl })
          });
          
          const updateResult = await updateRes.json();
          
          if (!updateRes.ok || updateResult.error) {
            throw new Error(updateResult.error || 'äºŒç»´ç æ›´æ–°å¤±è´¥');
          }
          
          // Update the display
          displayCurrentQRCode(qrcodeUrl);
          
          // Reset the form
          fileInput.value = '';
          preview.style.display = 'none';
          qrcodeBase64 = '';
          
          showStatus('äºŒç»´ç æ›´æ–°æˆåŠŸï¼', 'success');
          
        } catch (error) {
          console.error('Update error:', error);
          showStatus(`æ›´æ–°å¤±è´¥ï¼š${error.message}`, 'error');
        } finally {
          updateBtn.disabled = false;
          updateBtn.textContent = 'æ›´æ–°äºŒç»´ç ';
        }
      });
      
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${type}`;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    }
    
    // Edit functionality
    function initEditFunctionality(token, meetup) {
      const editButton = document.getElementById('edit-button');
      const cancelButton = document.getElementById('cancel-button');
      const saveButton = document.getElementById('save-button');
      const editForm = document.getElementById('edit-form');
      const meetupDisplay = document.getElementById('meetup-display');
      const successSummary = document.getElementById('success-summary');
      const editStatus = document.getElementById('edit-status');
      
      // Show edit form
      editButton.addEventListener('click', () => {
        editForm.style.display = 'block';
        meetupDisplay.style.display = 'none';
      });
      
      // Cancel editing
      cancelButton.addEventListener('click', () => {
        editForm.style.display = 'none';
        meetupDisplay.style.display = 'block';
        // Reset form values
        document.getElementById('edit-title').value = meetup.title;
        document.getElementById('edit-datetime').value = TimeUtils.formatDateTimeForInput(meetup.datetime);
        document.getElementById('edit-location').value = meetup.location;
        document.getElementById('edit-description').value = meetup.description;
        editStatus.style.display = 'none';
      });
      
      // Save changes
      saveButton.addEventListener('click', async () => {
        const title = document.getElementById('edit-title').value.trim();
        const datetime = document.getElementById('edit-datetime').value;
        const location = document.getElementById('edit-location').value.trim();
        const description = document.getElementById('edit-description').value.trim();
        
        if (!title || !datetime || !location || !description) {
          showEditStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
          return;
        }
        
        saveButton.disabled = true;
        saveButton.textContent = 'ä¿å­˜ä¸­...';
        
        try {
          // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´å¤„ç†å‡½æ•°åˆ›å»ºæ—¶é—´å¯¹è±¡
          const datetimeWithTimezone = TimeUtils.createDateTimeObject(datetime);
          
          const response = await fetch('/.netlify/functions/updateMeetup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              token,
              title,
              datetime: datetimeWithTimezone,
              location,
              description
            })
          });
          
          const result = await response.json();
          
          if (!response.ok || result.error) {
            throw new Error(result.error || 'æ›´æ–°å¤±è´¥');
          }
          
          // Update meetup object
          meetup.title = title;
          meetup.datetime = datetime;
          meetup.location = location;
          meetup.description = description;
          
          // Update display
          document.getElementById('display-title').textContent = title;
          document.getElementById('display-datetime').textContent = formatDateTime(datetime);
          document.getElementById('display-location').textContent = location;
          document.getElementById('display-description').textContent = description;
          
          // Return to view mode
          editForm.style.display = 'none';
          meetupDisplay.style.display = 'block';
          
          // Show success message
          showEditStatus('æ´»åŠ¨ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            editStatus.style.display = 'none';
          }, 3000);
          
        } catch (error) {
          console.error('Update error:', error);
          showEditStatus(`æ›´æ–°å¤±è´¥ï¼š${error.message}`, 'error');
        } finally {
          saveButton.disabled = false;
          saveButton.textContent = 'ä¿å­˜ä¿®æ”¹';
        }
      });
      
      function showEditStatus(message, type) {
        editStatus.textContent = message;
        editStatus.className = `status-message ${type}`;
        editStatus.style.display = 'block';
        
        setTimeout(() => {
          editStatus.style.display = 'none';
        }, 5000);
      }
    }
    
    // Global formatDateTime function
    function formatDateTime(datetimeStr) {
      // ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é—´æ˜¾ç¤ºå‡½æ•°
      return TimeUtils.formatDateTimeForDisplay(datetimeStr);
    }


  </script>
</body>
</html>
